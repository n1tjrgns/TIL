## [MySql] MySql InnoDB Lock

이전에 MySql 쿼리 실행 과정을 공부하던 중 gap lock, next key lock 얘기가 나와서 찾아보게 되었다.

바이너리 로그와 트랜잭션 격리 수준의 내용 부분에서 gap lock, next key lock에 대한 언급이 있었다.



> Lock은 뭘까?



Lock 은 말 그대로 `잠금`이다.

MySql에서 사용되는 잠금은 크게 스토리지 엔진 레벨과 MySql 엔진 레벨로 나눌 수 있다.

MySql 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠근은 스토리지 엔진 간에 상호 영향을 미치지 않는다.

- MySql 의 아키텍쳐를 보면 당연 할 것이라는 생각이 든다.



Storage Engine 중 하나인 InnoDB에서의 Lock을 보면, 여러 트랜잭션들이 경합하고 있는 상황에서 최대한의 성능을 위해 여러 방식의 다양한 락(Lock)을 조합해 사용하고 있다.



락에도 여러 종류가 있지만, 나는 우선 InnoDB 스토리지 엔진의 잠금 종류인 record lock, gap lock과, next key lock에 대해 알아보려 한다.





**InnoDB 스토리지 엔진의 잠금**

잠금에는 크게 비관적 잠금(Pessimistic locking)과 낙관적 잠금(Optimistic locking)이 있는데, InnoDB는 비관적 잠금을 사용한다.



- 비관적 잠금

현재 트랜잭션에서 변경하고자 하는 레코드에 대해 잠금을 먼저 획득하고 변경 작업을 처리하는 방식.

이 처리 방식은 이름에서도 느낄 수 있듯이 `현재 변경하고자 하는 레코드를 다른 트랜잭션에서도 변경할 수 있다라는 비관적인 가정`을 하기 때문에 먼저 잠금을 획득한다.



- 낙관적 잠금

`트랜잭션이 같은 레코드를 변경할 가능성은 상당히 희박할 것이라고(낙관적으로) 가정`한다. 그래서 변경 작업을 수행하고 마지막에 잠금 충돌이 있었는지를 확인해 문제가 있다면 ROLLBACK 처리를 하는 방식을 의미한다.





**InnoDB 스토리지 엔진의 잠금 종류**

- 레코드 락(RECORD LOCK)

`레코드 자체만을 잠그는 것`을 레코드 락이라고 한다. 다른 DBMS와의 차이점은 InnoDB 스토리지 엔진은 레코드 자체가 아니라 `인덱스의 레코드를 잠근다`.

만약 인덱스가 없는 테이블이라도, `내부적으로 자동 생성된 클러스터 인덱스를 이용`해 잠금을 설정한다. 프라이머리 키 또는 유니크 인덱스에 의한 변경작업은 갭에 대해서는 잠그지 않고 레코드 자체에 대해서만 락을 건다.



- 갭 락(Gap LOCK)

갭 락은 레코드 그 자체가 아니라 `레코드와 바로 인접한 레코드 사이의 간격을 잠그는 것을 의미`한다. 갭 라의 역할은 레코드와 레코드 사이의 새로운 레코드가 생성(Insert)되는 현상을 방지하는 것이다.

갭 락은 개념일 뿐 자체적으로 사용되지 않고, Next Key Lock 의 일부로 사용된다.



- 넥스트 키 락(Next Key Lock)

`레코드 락 + 갭 락 = 넥스트 키 락`이라고 한다. InnoDB에서 보조 인덱스를 이용하는 변경작업은 넥스트 키 락을 사용한다.

![1561196437911](C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\1561196437911.png)









또한 Lock을 공부할 때는 `트랜잭션`과 함께 공부해야 한다.



**트랜잭션**

트랜잭션은 논리적인 작업을 모두 완벽하게 처리하거나 또는 처리하지 못할 경우 `원 상태로 복구`해서 작업의 일부만 적용되는 현상이 발생하지 않게 만들어서 `작업의 완전성을 보장`해주는 기능이다.





**트랜잭션과 락의 차이점**

- 트랜잭션은 데이터의 원자성(Atomicity)을 보장하기 위한 기능 (안정성)
- 락은 데이터의 고립성(Isolation)을 제어하기 위한 기능 (다른 트랜잭션의 연산 작업이 끼어들지 못하게)







참고

<https://idea-sketch.tistory.com/45>

<https://www.letmecompile.com/mysql-innodb-lock-deadlock/>