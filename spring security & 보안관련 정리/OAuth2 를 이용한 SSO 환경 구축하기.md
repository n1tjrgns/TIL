## OAuth2 를 이용한 SSO 환경 구축하기

SSO(Single Sign On)을 구성하는 방법은 크게 두 가지가 있다.

- SSO 전용 오픈 소스 CAS 서버를 이용하는 방안
- 서비스 자원에 대한 접근 제어 인가 흐름(Authorization Flow)을 제공하는 OAuth2를 이용하는 방안
  - OAuth2를 이용하면 웹, 모바일, 데스크탑, IOT 장치로의 확장이 뛰어나다.



#### OAuth2

API를 통해 특정 시스템의 보호된 자원에 접근하기 위해서는 해당 시스템의 사용자 인증 정보(id, pw)를 알고 있어야 한다. 

시스템 차원에서 다른 시스템의 보호된 자원에 접근하기 위해 그 시스템의 사용자 인증 정보를 관리하고 이 정보를 사용하는 것은 보안상 많은 문제들을 유발할 수 있다.

이런 문제들이 발생하지 않도록 API 접근을 위임하여 인증을 처리하는 방법을 사용할 수 있다.

> API 서버에서는 인증과 관련된 정보를 가짖고 있지 않기 때문에 호출시마다 Access Token을 사용해서 OAuth2 서버로 요청하여 정보를 가져온다.
>
> 나중에 사용자가 많아지고 트래픽이 늘어나게 되면 API 서버에서 적절하게 캐시를 사용해서 컨트롤해야 하는 부분도 있다.  하지만 요청한 Access Token이 유효한지 문제가 없는지 계속 확인해야 하기 때문에 OAuth2 서버에도 주기적으로 체크해줘야 한다. 이 부분을 잘 컨트롤해줘야 많은 트래픽에 견딜 수 있는 인증서버 API서버를 만들 수 있다.

이러한 부분을 해결하기 위해 나온 형태가 JWT(Json Web Token) 방식이다.

간단하게 말하면, JSON 형식의 데이터를 인코딩 하여 토큰으로 이용하는 형태라고 생각하면 될 것 같다.

이전의 OAuth2 서버가 Access Token만 발급한 후 필요한 정보를 Access Token을 통해 정보를 조회하는 형태라면, JWT는 (JSON 형태의) 데이터가 직접 붙어 있는 토큰을 OAuth2 서버에서 발급하는 형태다.

그래서 직접 다시 Access Token을 이용하여 조회할 필요 없이 JWT 토큰에 붙어 있는 정보를 바로 사용하게 된다.





많은 서비스 회사들이 이러한 인증 방식을 별도로 구현하여 사용했다. 이렇게 구현한 결과들은 서로 조금씩 다르고 서로 호환되지 않아 이를 통일하기 위해 OAuth 1.0 표준안을 만들었다.

하지만 1.0을 사용하면서

- 암호화 요구사항의 복잡성
- 웹 기반 어플리케이션만 지원가능
- 성능 확장의 어려움

의 문제들로 인해 OAuth2 를 표준으로 정했다.



#### OAuth의 역할

| 역할                            | 설명                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| 자원 서버(Resource Server)      | 자원 서버는 보호된 정보를 제공하는 서버로 일반적으로 웹 어플리케이션이다. |
| 자원 소유자(Resource Owner)     | 자원 소유자는 자원 서버에 계정을 가지고 있는 사용자로 클라이언트가 그들의 계정을 통해 자원 서버에 접근하는 것을 인가(authorize)라고 한다. |
| 클라이언트(Client)              | 클라이언트는 자원 소유자를 대신하여 자원 서버의 서비스를 사용하고자하는 어플리케이션이다. |
| 인가 서버(Authorization Server) | 인가 서버는 클라이언트가 자원 서버의 서비스를 사용할 때 사용하는 접근토큰(Access Token)을 발행한다. |



#### 인가 승인 유형(Authorization Grant Types)

클라이언트가 접근 토큰을 요청하기 위해서는 자원 소유자의 인가를 받아야 하는데 OAuth는 서로 다른 용도를 위해 다양한 인가 승인 유형을 제공한다.

OAuth에서 정의한 4가지 인가 승인 유형을 보자

| 인가 승인 유형                                     | 용도                                               | 비고                                       |
| -------------------------------------------------- | -------------------------------------------------- | ------------------------------------------ |
| 인가 코드 승인(Authorization Code)                 | 웹 서버 상에서 동작하는 어플리케이션               | 가장 많이 사용되는 유형                    |
| 암시적 승인(Implicit)                              | 모바일 앱 또는 단말기에서 동작하는 웹 어플리케이션 |                                            |
| 자원 소유자 패스워드 승인(Resource Owner Password) | 단말기 OS 또는 높은 신뢰 관계의 어플리케이션       | 다른 유형들을 사용할 수 없는 경우에만 사용 |
| 클라이언트 인증 정보 승인(Client Credentials)      | 어플리케이션 API 접근                              | 신뢰하는 클라이언트만 사용                 |



#### OAuth 구현시 보안 고려사항

OAuth를 구현할 때 3가지의 시스템, 즉 클라이언트, 인가 서버, 자원 서버를 구현할 수 있다.

각각의 역할이 다르며 그에 따른 보안에 대한 고려사항 또한 다르게 적용되어야 한다.

그리고 최종적으로 발급되는 접근 토큰에 대한 보안도 고려해야 할 사항이다.





##### 참고

<http://www.nextree.co.kr/oauth-2reul-iyonghan-sso-hwangyeong-gucug-1-2/>